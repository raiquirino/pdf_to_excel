<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Leitor de Extrato BancÃ¡rio</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h2 {
      color: #333;
    }
    input[type="file"] {
      margin-bottom: 20px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background-color: #fff;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #eee;
    }
    tr:nth-child(even) {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <h2>ðŸ“„ Leitor de Extrato BancÃ¡rio (PDF)</h2>
  <input type="file" id="fileInput" accept="application/pdf" />
  <table id="tabelaExtrato">
    <thead></thead>
    <tbody></tbody>
  </table>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('fileInput');
      const tabela = document.getElementById('tabelaExtrato');
      const thead = tabela.querySelector('thead');
      const tbody = tabela.querySelector('tbody');

      fileInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function () {
          const typedArray = new Uint8Array(reader.result);
          const pdf = await pdfjsLib.getDocument(typedArray).promise;
          let linhasAgrupadas = [];

          for (let i = 1; i <= pdf.numPages; i++) {
            const page = await pdf.getPage(i);
            const content = await page.getTextContent();

            const linhasPorY = {};

            content.items.forEach(item => {
              const y = Math.round(item.transform[5]);
              const x = Math.round(item.transform[4]);
              if (!linhasPorY[y]) linhasPorY[y] = [];
              linhasPorY[y].push({ x, texto: item.str });
            });

            const linhas = Object.values(linhasPorY).map(linha => {
              return linha
                .sort((a, b) => a.x - b.x)
                .map(item => item.texto)
                .join(' ')
                .trim();
            });

            linhasAgrupadas.push(...linhas);
          }

          // Detectar cabeÃ§alho
          let colunas = [];
          for (let linha of linhasAgrupadas) {
            if (
              linha.toLowerCase().includes('data') &&
              linha.toLowerCase().includes('valor')
            ) {
              colunas = linha.split(/\s{2,}|\t| {3,}/).filter(c => c.length > 1);
              break;
            }
          }

          // Criar cabeÃ§alho dinÃ¢mico
          thead.innerHTML = '';
          const headerRow = document.createElement('tr');
          colunas.forEach(coluna => {
            const th = document.createElement('th');
            th.textContent = coluna;
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);

          // Preencher corpo da tabela
          tbody.innerHTML = '';
          linhasAgrupadas.forEach(linha => {
            const valores = linha.split(/\s{2,}|\t| {3,}/).filter(v => v.length > 0);
            if (valores.length === colunas.length) {
              const tr = document.createElement('tr');
              valores.forEach(valor => {
                const td = document.createElement('td');
                td.textContent = valor;
                tr.appendChild(td);
              });
              tbody.appendChild(tr);
            }
          });
        };
        reader.readAsArrayBuffer(file);
      });
    });
  </script>
</body>
</html>